import{x as vt,y as ee,f as C,z as Dt,A as se,h as z,H as ne,V as re,l as nt,o as E,v as W,J as b,s as At,K as Ft,L as lt,M as L,w as ae,N as oe,j as Ht,i as Ut,O as ie,Q as le,W as ce,k as he,F as de,X as ue,D as Et,Y as pe,Z as fe}from"./index-eLHBiePR.js";import{c as me,R as xe,S as ge,B as Ce,a as _e,b as ye,d as ve,A as be,C as Te}from"./RenderTargetSystem-BmcJdQqo.js";import{S as Wt}from"./Filter-9wV2tSfY.js";class Se{constructor(){this.isBatchable=!1}reset(){this.isBatchable=!1,this.context=null,this.graphicsData&&(this.graphicsData.destroy(),this.graphicsData=null)}destroy(){this.reset()}}class Pe{constructor(){this.instructions=new ee}init(){this.instructions.reset()}destroy(){this.instructions.destroy(),this.instructions=null}}const bt=class yt{constructor(t){this._renderer=t,this._managedContexts=new vt({renderer:t,type:"resource",name:"graphicsContext"})}init(t){yt.defaultOptions.bezierSmoothness=(t==null?void 0:t.bezierSmoothness)??yt.defaultOptions.bezierSmoothness}getContextRenderData(t){return this.getGpuContext(t).graphicsData||this._initContextRenderData(t)}updateGpuContext(t){const e=t._gpuData,s=!!e[this._renderer.uid],n=e[this._renderer.uid]||this._initContext(t);return(t.dirty||!s)&&(s&&n.reset(),n.isBatchable=!1,t.dirty=!1),n}getGpuContext(t){return t._gpuData[this._renderer.uid]||this._initContext(t)}_initContextRenderData(t){const e=new Pe,s=this.getGpuContext(t);return s.graphicsData=e,e.init(),e}_initContext(t){const e=new Se;return e.context=t,t._gpuData[this._renderer.uid]=e,this._managedContexts.add(t),e}destroy(){this._managedContexts.destroy(),this._renderer=null}};bt.extension={type:[C.CanvasSystem],name:"graphicsContext"};bt.defaultOptions={bezierSmoothness:.5};let Me=bt;class Lt{constructor(t,e){this.state=Wt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new vt({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){return!1}addRenderable(t,e){this._managedGraphics.add(t),this.renderer.renderPipes.batch.break(e),e.add(t)}updateRenderable(t){}execute(t){t.isRenderable&&this._adaptor.execute(this,t)}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null}}Lt.extension={type:[C.CanvasPipes],name:"graphics"};class ke{constructor(){this.batches=[],this.batched=!1}destroy(){this.batches.forEach(t=>{Dt.return(t)}),this.batches.length=0}}class qt{constructor(t,e){this.state=Wt.for2d(),this.renderer=t,this._adaptor=e,this.renderer.runners.contextChange.add(this),this._managedGraphics=new vt({renderer:t,type:"renderable",priority:-1,name:"graphics"})}contextChange(){this._adaptor.contextChange(this.renderer)}validateRenderable(t){const e=t.context,s=!!t._gpuData,r=this.renderer.graphicsContext.updateGpuContext(e);return!!(r.isBatchable||s!==r.isBatchable)}addRenderable(t,e){const n=this.renderer.graphicsContext.updateGpuContext(t.context);t.didViewUpdate&&this._rebuild(t),n.isBatchable?this._addToBatcher(t,e):(this.renderer.renderPipes.batch.break(e),e.add(t))}updateRenderable(t){const s=this._getGpuDataForRenderable(t).batches;for(let n=0;n<s.length;n++){const r=s[n];r._batcher.updateElement(r)}}execute(t){if(!t.isRenderable)return;const e=this.renderer,s=t.context;if(!e.graphicsContext.getGpuContext(s).batches.length)return;const r=s.customShader||this._adaptor.shader;this.state.blendMode=t.groupBlendMode;const o=r.resources.localUniforms.uniforms;o.uTransformMatrix=t.groupTransform,o.uRound=e._roundPixels|t._roundPixels,me(t.groupColorAlpha,o.uColor,0),this._adaptor.execute(this,t)}_rebuild(t){const e=this._getGpuDataForRenderable(t),n=this.renderer.graphicsContext.updateGpuContext(t.context);e.destroy(),n.isBatchable&&this._updateBatchesForRenderable(t,e)}_addToBatcher(t,e){const s=this.renderer.renderPipes.batch,n=this._getGpuDataForRenderable(t).batches;for(let r=0;r<n.length;r++){const o=n[r];s.addToBatch(o,e)}}_getGpuDataForRenderable(t){return t._gpuData[this.renderer.uid]||this._initGpuDataForRenderable(t)}_initGpuDataForRenderable(t){const e=new ke;return t._gpuData[this.renderer.uid]=e,this._managedGraphics.add(t),e}_updateBatchesForRenderable(t,e){const s=t.context,r=this.renderer.graphicsContext.getGpuContext(s),o=this.renderer._roundPixels|t._roundPixels;e.batches=r.batches.map(i=>{const l=Dt.get(se);return i.copyTo(l),l.renderable=t,l.roundPixels=o,l})}destroy(){this._managedGraphics.destroy(),this.renderer=null,this._adaptor.destroy(),this._adaptor=null,this.state=null}}qt.extension={type:[C.WebGLPipes,C.WebGPUPipes],name:"graphics"};z.add(Lt);z.add(qt);z.add(Me);z.add(ne);class ht extends re{constructor(t){t instanceof nt&&(t={context:t});const{context:e,roundPixels:s,...n}=t||{};super({label:"Graphics",...n}),this.renderPipeId="graphics",e?this.context=e:(this.context=this._ownedContext=new nt,this.context.autoGarbageCollect=this.autoGarbageCollect),this.didViewUpdate=!0,this.allowChildren=!1,this.roundPixels=s??!1}set context(t){t!==this._context&&(this._context&&(this._context.off("update",this.onViewUpdate,this),this._context.off("unload",this.unload,this)),this._context=t,this._context.on("update",this.onViewUpdate,this),this._context.on("unload",this.unload,this),this.onViewUpdate())}get context(){return this._context}get bounds(){return this._context.bounds}updateBounds(){}containsPoint(t){return this._context.containsPoint(t)}destroy(t){this._ownedContext&&!t?this._ownedContext.destroy(t):(t===!0||(t==null?void 0:t.context)===!0)&&this._context.destroy(t),this._ownedContext=null,this._context=null,super.destroy(t)}_onTouch(t){this._gcLastUsed=t,this._context._gcLastUsed=t}_callContextMethod(t,e){return this.context[t](...e),this}setFillStyle(...t){return this._callContextMethod("setFillStyle",t)}setStrokeStyle(...t){return this._callContextMethod("setStrokeStyle",t)}fill(...t){return this._callContextMethod("fill",t)}stroke(...t){return this._callContextMethod("stroke",t)}texture(...t){return this._callContextMethod("texture",t)}beginPath(){return this._callContextMethod("beginPath",[])}cut(){return this._callContextMethod("cut",[])}arc(...t){return this._callContextMethod("arc",t)}arcTo(...t){return this._callContextMethod("arcTo",t)}arcToSvg(...t){return this._callContextMethod("arcToSvg",t)}bezierCurveTo(...t){return this._callContextMethod("bezierCurveTo",t)}closePath(){return this._callContextMethod("closePath",[])}ellipse(...t){return this._callContextMethod("ellipse",t)}circle(...t){return this._callContextMethod("circle",t)}path(...t){return this._callContextMethod("path",t)}lineTo(...t){return this._callContextMethod("lineTo",t)}moveTo(...t){return this._callContextMethod("moveTo",t)}quadraticCurveTo(...t){return this._callContextMethod("quadraticCurveTo",t)}rect(...t){return this._callContextMethod("rect",t)}roundRect(...t){return this._callContextMethod("roundRect",t)}poly(...t){return this._callContextMethod("poly",t)}regularPoly(...t){return this._callContextMethod("regularPoly",t)}roundPoly(...t){return this._callContextMethod("roundPoly",t)}roundShape(...t){return this._callContextMethod("roundShape",t)}filletRect(...t){return this._callContextMethod("filletRect",t)}chamferRect(...t){return this._callContextMethod("chamferRect",t)}star(...t){return this._callContextMethod("star",t)}svg(...t){return this._callContextMethod("svg",t)}restore(...t){return this._callContextMethod("restore",t)}save(){return this._callContextMethod("save",[])}getTransform(){return this.context.getTransform()}resetTransform(){return this._callContextMethod("resetTransform",[])}rotateTransform(...t){return this._callContextMethod("rotate",t)}scaleTransform(...t){return this._callContextMethod("scale",t)}setTransform(...t){return this._callContextMethod("setTransform",t)}transform(...t){return this._callContextMethod("transform",t)}translateTransform(...t){return this._callContextMethod("translate",t)}clear(){return this._callContextMethod("clear",[])}get fillStyle(){return this._context.fillStyle}set fillStyle(t){this._context.fillStyle=t}get strokeStyle(){return this._context.strokeStyle}set strokeStyle(t){this._context.strokeStyle=t}clone(t=!1){return t?new ht(this._context.clone()):(this._ownedContext=null,new ht(this._context))}lineStyle(t,e,s){E(W,"Graphics#lineStyle is no longer needed. Use Graphics#setStrokeStyle to set the stroke style.");const n={};return t&&(n.width=t),e&&(n.color=e),s&&(n.alpha=s),this.context.strokeStyle=n,this}beginFill(t,e){E(W,"Graphics#beginFill is no longer needed. Use Graphics#fill to fill the shape with the desired style.");const s={};return t!==void 0&&(s.color=t),e!==void 0&&(s.alpha=e),this.context.fillStyle=s,this}endFill(){E(W,"Graphics#endFill is no longer needed. Use Graphics#fill to fill the shape with the desired style."),this.context.fill();const t=this.context.strokeStyle;return(t.width!==nt.defaultStrokeStyle.width||t.color!==nt.defaultStrokeStyle.color||t.alpha!==nt.defaultStrokeStyle.alpha)&&this.context.stroke(),this}drawCircle(...t){return E(W,"Graphics#drawCircle has been renamed to Graphics#circle"),this._callContextMethod("circle",t)}drawEllipse(...t){return E(W,"Graphics#drawEllipse has been renamed to Graphics#ellipse"),this._callContextMethod("ellipse",t)}drawPolygon(...t){return E(W,"Graphics#drawPolygon has been renamed to Graphics#poly"),this._callContextMethod("poly",t)}drawRect(...t){return E(W,"Graphics#drawRect has been renamed to Graphics#rect"),this._callContextMethod("rect",t)}drawRoundedRect(...t){return E(W,"Graphics#drawRoundedRect has been renamed to Graphics#roundRect"),this._callContextMethod("roundRect",t)}drawStar(...t){return E(W,"Graphics#drawStar has been renamed to Graphics#star"),this._callContextMethod("star",t)}}const Tt=class J{static _getPatternRepeat(t,e){const s=t&&t!=="clamp-to-edge",n=e&&e!=="clamp-to-edge";return s&&n?"repeat":s?"repeat-x":n?"repeat-y":"no-repeat"}start(t,e,s){}execute(t,e){var i,l,m,x;const s=e.elements;if(!s||!s.length)return;const n=t.renderer,r=n.canvasContext,o=r.activeContext;for(let R=0;R<s.length;R++){const A=s[R];if(!A.packAsQuad)continue;const g=A,p=g.texture,G=p?b.getCanvasSource(p):null;if(!G)continue;const _=p.source.style,B=r.smoothProperty,q=_.scaleMode!=="nearest";o[B]!==q&&(o[B]=q),r.setBlendMode(e.blendMode);const F=((i=n.globalUniforms.globalUniformData)==null?void 0:i.worldColor)??4294967295,T=g.color,y=(F>>>24&255)/255,X=(T>>>24&255)/255,rt=((l=n.filter)==null?void 0:l.alphaMultiplier)??1,tt=y*X*rt;if(tt<=0)continue;o.globalAlpha=tt;const et=F&16777215,K=T&16777215,S=Ft(lt(K,et)),M=p.frame,k=_.addressModeU??_.addressMode,dt=_.addressModeV??_.addressMode,st=J._getPatternRepeat(k,dt),O=p.source._resolution??p.source.resolution??1,$=(x=(m=g.renderable)==null?void 0:m.renderGroup)==null?void 0:x.isCachedAsTexture,d=M.x*O,u=M.y*O,f=M.width*O,V=M.height*O,w=g.bounds,P=n.renderTarget.renderTarget.isRoot,H=w.minX,U=w.minY,I=w.maxX-w.minX,D=w.maxY-w.minY,N=p.rotate,c=p.uvs,j=Math.min(c.x0,c.x1,c.x2,c.x3,c.y0,c.y1,c.y2,c.y3),Y=Math.max(c.x0,c.x1,c.x2,c.x3,c.y0,c.y1,c.y2,c.y3),v=st!=="no-repeat"&&(j<0||Y>1),ut=N&&!(!v&&(S!==16777215||N));ut?(J._tempPatternMatrix.copyFrom(g.transform),At.matrixAppendRotationInv(J._tempPatternMatrix,N,H,U,I,D),r.setContextTransform(J._tempPatternMatrix,g.roundPixels===1,void 0,$&&P)):r.setContextTransform(g.transform,g.roundPixels===1,void 0,$&&P);const at=ut?0:H,ot=ut?0:U,pt=I,ft=D;if(v){let mt=G;const Q=S!==16777215&&!N,Z=M.width<=p.source.width&&M.height<=p.source.height;Q&&Z&&(mt=b.getTintedCanvas({texture:p},S));const xt=o.createPattern(mt,st);if(!xt)continue;const Pt=pt,Mt=ft;if(Pt===0||Mt===0)continue;const kt=1/Pt,wt=1/Mt,Rt=(c.x1-c.x0)*kt,Gt=(c.y1-c.y0)*kt,Bt=(c.x3-c.x0)*wt,It=(c.y3-c.y0)*wt,Zt=c.x0-Rt*at-Bt*ot,te=c.y0-Gt*at-It*ot,gt=p.source.pixelWidth,Ct=p.source.pixelHeight;J._tempPatternMatrix.set(Rt*gt,Gt*Ct,Bt*gt,It*Ct,Zt*gt,te*Ct),b.applyPatternTransform(xt,J._tempPatternMatrix),o.fillStyle=xt,o.fillRect(at,ot,pt,ft)}else{const Q=S!==16777215||N?b.getTintedCanvas({texture:p},S):G,Z=Q!==G;o.drawImage(Q,Z?0:d,Z?0:u,Z?Q.width:f,Z?Q.height:V,at,ot,pt,ft)}}}};Tt._tempPatternMatrix=new L;Tt.extension={type:[C.CanvasPipesAdaptor],name:"batch"};let we=Tt;class Ot{constructor(t){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=t}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;n[this._colorStackIndex]=n[this._colorStackIndex-1]&t.mask;const r=this._colorStack[this._colorStackIndex];r!==this._currentColor&&(this._currentColor=r,s.add({renderPipeId:"colorMask",colorMask:r,canBundle:!1})),this._colorStackIndex++}pop(t,e,s){this._renderer.renderPipes.batch.break(s);const n=this._colorStack;this._colorStackIndex--;const r=n[this._colorStackIndex-1];r!==this._currentColor&&(this._currentColor=r,s.add({renderPipeId:"colorMask",colorMask:r,canBundle:!1}))}execute(t){}destroy(){this._renderer=null,this._colorStack=null}}Ot.extension={type:[C.CanvasPipes],name:"colorMask"};function Re(a,t,e,s,n,r){r=Math.max(0,Math.min(r,Math.min(s,n)/2)),a.moveTo(t+r,e),a.lineTo(t+s-r,e),a.quadraticCurveTo(t+s,e,t+s,e+r),a.lineTo(t+s,e+n-r),a.quadraticCurveTo(t+s,e+n,t+s-r,e+n),a.lineTo(t+r,e+n),a.quadraticCurveTo(t,e+n,t,e+n-r),a.lineTo(t,e+r),a.quadraticCurveTo(t,e,t+r,e)}function Vt(a,t){switch(t.type){case"rectangle":{const e=t;a.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;Re(a,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;a.moveTo(e.x+e.radius,e.y),a.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;a.ellipse?(a.moveTo(e.x+e.halfWidth,e.y),a.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2)):(a.save(),a.translate(e.x,e.y),a.scale(e.halfWidth,e.halfHeight),a.moveTo(1,0),a.arc(0,0,1,0,Math.PI*2),a.restore());break}case"triangle":{const e=t;a.moveTo(e.x,e.y),a.lineTo(e.x2,e.y2),a.lineTo(e.x3,e.y3),a.closePath();break}case"polygon":default:{const e=t,s=e.points;if(!(s!=null&&s.length))break;a.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)a.lineTo(s[n],s[n+1]);e.closePath&&a.closePath();break}}}function Ge(a,t){if(!(t!=null&&t.length))return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!(s!=null&&s.shape))continue;const n=s.transform,r=n&&!n.isIdentity();r&&(a.save(),a.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),Vt(a,s.shape),r&&a.restore()}return!0}class Nt{constructor(t){this._warnedMaskTypes=new Set,this._canvasMaskStack=[],this._renderer=t}push(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}pop(t,e,s){this._renderer.renderPipes.batch.break(s),s.add({renderPipeId:"stencilMask",action:"popMaskEnd",mask:t,inverse:e._maskOptions.inverse,canBundle:!1})}execute(t){var x,R,A;if(t.action!=="pushMaskBegin"&&t.action!=="popMaskEnd")return;const e=this._renderer,s=e.canvasContext,n=s==null?void 0:s.activeContext;if(!n)return;if(t.action==="popMaskEnd"){this._canvasMaskStack.pop()&&n.restore();return}t.inverse&&this._warnOnce("inverse","CanvasRenderer: inverse masks are not supported on Canvas2D; ignoring inverse flag.");const r=t.mask.mask;if(!(r instanceof ht)){this._warnOnce("nonGraphics","CanvasRenderer: only Graphics masks are supported in Canvas2D; skipping mask."),this._canvasMaskStack.push(!1);return}const o=r,i=(x=o.context)==null?void 0:x.instructions;if(!(i!=null&&i.length)){this._canvasMaskStack.push(!1);return}n.save(),s.setContextTransform(o.groupTransform,(e._roundPixels|o._roundPixels)===1),n.beginPath();let l=!1,m=!1;for(let g=0;g<i.length;g++){const p=i[g],G=p.action;if(G!=="fill"&&G!=="stroke")continue;const _=p.data,B=(R=_==null?void 0:_.path)==null?void 0:R.shapePath;if(!((A=B==null?void 0:B.shapePrimitives)!=null&&A.length))continue;const q=B.shapePrimitives;for(let F=0;F<q.length;F++){const T=q[F];if(!(T!=null&&T.shape))continue;const y=T.transform,X=y&&!y.isIdentity();X&&(n.save(),n.transform(y.a,y.b,y.c,y.d,y.tx,y.ty)),Vt(n,T.shape),m=Ge(n,T.holes)||m,l=!0,X&&n.restore()}}if(!l){n.restore(),this._canvasMaskStack.push(!1);return}m?n.clip("evenodd"):n.clip(),this._canvasMaskStack.push(!0)}destroy(){this._renderer=null,this._warnedMaskTypes=null,this._canvasMaskStack=null}_warnOnce(t,e){this._warnedMaskTypes.has(t)||(this._warnedMaskTypes.add(t),ae(e))}}Nt.extension={type:[C.CanvasPipes],name:"stencilMask"};const h="source-over";function Be(){const a=oe(),t=Object.create(null);return t.inherit=h,t.none=h,t.normal="source-over",t.add="lighter",t.multiply=a?"multiply":h,t.screen=a?"screen":h,t.overlay=a?"overlay":h,t.darken=a?"darken":h,t.lighten=a?"lighten":h,t["color-dodge"]=a?"color-dodge":h,t["color-burn"]=a?"color-burn":h,t["hard-light"]=a?"hard-light":h,t["soft-light"]=a?"soft-light":h,t.difference=a?"difference":h,t.exclusion=a?"exclusion":h,t.saturation=a?"saturation":h,t.color=a?"color":h,t.luminosity=a?"luminosity":h,t["linear-burn"]=a?"color-burn":h,t["linear-dodge"]=a?"color-dodge":h,t["linear-light"]=a?"hard-light":h,t["pin-light"]=a?"hard-light":h,t["vivid-light"]=a?"hard-light":h,t["hard-mix"]=h,t.negation=a?"difference":h,t["normal-npm"]=t.normal,t["add-npm"]=t.add,t["screen-npm"]=t.screen,t.erase="destination-out",t.subtract=h,t.divide=h,t.min=h,t.max=h,t}const Ie=new L;class jt{constructor(t){this.activeResolution=1,this.smoothProperty="imageSmoothingEnabled",this.blendModes=Be(),this._activeBlendMode="normal",this._projTransform=null,this._outerBlend=!1,this._warnedBlendModes=new Set,this._renderer=t}resolutionChange(t){this.activeResolution=t}init(){const t=this._renderer.background.alpha<1;if(this.rootContext=this._renderer.canvas.getContext("2d",{alpha:t}),this.activeContext=this.rootContext,this.activeResolution=this._renderer.resolution,!this.rootContext.imageSmoothingEnabled){const e=this.rootContext;e.webkitImageSmoothingEnabled?this.smoothProperty="webkitImageSmoothingEnabled":e.mozImageSmoothingEnabled?this.smoothProperty="mozImageSmoothingEnabled":e.oImageSmoothingEnabled?this.smoothProperty="oImageSmoothingEnabled":e.msImageSmoothingEnabled&&(this.smoothProperty="msImageSmoothingEnabled")}}setContextTransform(t,e,s,n){var m;const r=n?L.IDENTITY:((m=this._renderer.globalUniforms.globalUniformData)==null?void 0:m.worldTransformMatrix)||L.IDENTITY;let o=Ie;o.copyFrom(r),o.append(t);const i=this._projTransform,l=this.activeResolution;if(s=s||l,i){const x=L.shared;x.copyFrom(o),x.prepend(i),o=x}e?this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*l|0,o.ty*l|0):this.activeContext.setTransform(o.a*s,o.b*s,o.c*s,o.d*s,o.tx*l,o.ty*l)}clear(t,e){const s=this.activeContext,n=this._renderer;if(s.clearRect(0,0,n.width,n.height),t){const r=Ht.shared.setValue(t);s.globalAlpha=e??r.alpha,s.fillStyle=r.toHex(),s.fillRect(0,0,n.width,n.height),s.globalAlpha=1}}setBlendMode(t){if(this._activeBlendMode===t)return;this._activeBlendMode=t,this._outerBlend=!1;const e=this.blendModes[t];if(!e){this._warnedBlendModes.has(t)||(console.warn(`CanvasRenderer: blend mode "${t}" is not supported in Canvas2D; falling back to "source-over".`),this._warnedBlendModes.add(t)),this.activeContext.globalCompositeOperation="source-over";return}this.activeContext.globalCompositeOperation=e}destroy(){this.rootContext=null,this.activeContext=null,this._warnedBlendModes.clear()}}jt.extension={type:[C.CanvasSystem],name:"canvasContext"};class Yt{constructor(){this.maxTextures=16,this.maxBatchableTextures=16,this.maxUniformBindings=0}init(){}}Yt.extension={type:[C.CanvasSystem],name:"limits"};const De="#808080",it=new L,Ae=new L,Fe=new L,_t=new L;function He(a,t,e){a.beginPath();for(let s=0;s<e.length;s+=3){const n=e[s]*2,r=e[s+1]*2,o=e[s+2]*2;a.moveTo(t[n],t[n+1]),a.lineTo(t[r],t[r+1]),a.lineTo(t[o],t[o+1]),a.closePath()}a.fill()}function Ue(a){return`#${(a&16777215).toString(16).padStart(6,"0")}`}function Ee(a,t,e,s,n,r){r=Math.max(0,Math.min(r,Math.min(s,n)/2)),a.moveTo(t+r,e),a.lineTo(t+s-r,e),a.quadraticCurveTo(t+s,e,t+s,e+r),a.lineTo(t+s,e+n-r),a.quadraticCurveTo(t+s,e+n,t+s-r,e+n),a.lineTo(t+r,e+n),a.quadraticCurveTo(t,e+n,t,e+n-r),a.lineTo(t,e+r),a.quadraticCurveTo(t,e,t+r,e)}function ct(a,t){switch(t.type){case"rectangle":{const e=t;a.rect(e.x,e.y,e.width,e.height);break}case"roundedRectangle":{const e=t;Ee(a,e.x,e.y,e.width,e.height,e.radius);break}case"circle":{const e=t;a.arc(e.x,e.y,e.radius,0,Math.PI*2);break}case"ellipse":{const e=t;a.ellipse?a.ellipse(e.x,e.y,e.halfWidth,e.halfHeight,0,0,Math.PI*2):(a.save(),a.translate(e.x,e.y),a.scale(e.halfWidth,e.halfHeight),a.arc(0,0,1,0,Math.PI*2),a.restore());break}case"triangle":{const e=t;a.moveTo(e.x,e.y),a.lineTo(e.x2,e.y2),a.lineTo(e.x3,e.y3),a.closePath();break}case"polygon":default:{const e=t,s=e.points;if(!(s!=null&&s.length))break;a.moveTo(s[0],s[1]);for(let n=2;n<s.length;n+=2)a.lineTo(s[n],s[n+1]);e.closePath&&a.closePath();break}}}function We(a,t){if(!(t!=null&&t.length))return!1;for(let e=0;e<t.length;e++){const s=t[e];if(!(s!=null&&s.shape))continue;const n=s.transform,r=n&&!n.isIdentity();r&&(a.save(),a.transform(n.a,n.b,n.c,n.d,n.tx,n.ty)),ct(a,s.shape),r&&a.restore()}return!0}function Le(a,t,e,s){const n=a.fill;if(n instanceof he){n.buildGradient();const o=n.texture;if(o){const i=b.getTintedPattern(o,t),l=e?_t.copyFrom(e).scale(o.source.pixelWidth,o.source.pixelHeight):_t.copyFrom(n.transform);return s&&!a.textureSpace&&l.append(s),b.applyPatternTransform(i,l),i}}if(n instanceof de){const o=b.getTintedPattern(n.texture,t);return b.applyPatternTransform(o,n.transform),o}const r=a.texture;if(r&&r!==Ut.WHITE){if(!r.source.resource)return De;const o=b.getTintedPattern(r,t),i=e?_t.copyFrom(e).scale(r.source.pixelWidth,r.source.pixelHeight):a.matrix;return b.applyPatternTransform(o,i),o}return Ue(t)}class zt{constructor(){this.shader=null}contextChange(t){}execute(t,e){var q,F,T,y,X,rt,tt;const s=t.renderer,n=s.canvasContext,r=n.activeContext,o=e.groupTransform,i=((q=s.globalUniforms.globalUniformData)==null?void 0:q.worldColor)??4294967295,l=e.groupColorAlpha,m=(i>>>24&255)/255,x=(l>>>24&255)/255,R=((F=s.filter)==null?void 0:F.alphaMultiplier)??1,A=m*x*R;if(A<=0)return;const g=i&16777215,p=l&16777215,G=Ft(lt(p,g)),_=s._roundPixels|e._roundPixels;r.save(),n.setContextTransform(o,_===1),n.setBlendMode(e.groupBlendMode);const B=e.context.instructions;for(let et=0;et<B.length;et++){const K=B[et];if(K.action==="texture"){const d=K.data,u=d.image,f=u?b.getCanvasSource(u):null;if(!f)continue;const V=d.alpha*A;if(V<=0)continue;const w=lt(d.style,G);r.globalAlpha=V;let P=f;w!==16777215&&(P=b.getTintedCanvas({texture:u},w));const H=u.frame,U=u.source._resolution??u.source.resolution??1;let I=H.x*U,D=H.y*U;const N=H.width*U,c=H.height*U;P!==f&&(I=0,D=0);const j=d.transform,Y=j&&!j.isIdentity(),v=u.rotate;Y||v?(it.copyFrom(o),Y&&it.append(j),v&&At.matrixAppendRotationInv(it,v,d.dx,d.dy,d.dw,d.dh),n.setContextTransform(it,_===1)):n.setContextTransform(o,_===1),r.drawImage(P,I,D,P===f?N:P.width,P===f?c:P.height,v?0:d.dx,v?0:d.dy,d.dw,d.dh),(Y||v)&&n.setContextTransform(o,_===1);continue}const S=K.data,M=(T=S==null?void 0:S.path)==null?void 0:T.shapePath;if(!((y=M==null?void 0:M.shapePrimitives)!=null&&y.length))continue;const k=S.style,dt=lt(k.color,G),st=k.alpha*A;if(st<=0)continue;const O=K.action==="stroke";if(r.globalAlpha=st,O){const d=k;r.lineWidth=d.width,r.lineCap=d.cap,r.lineJoin=d.join,r.miterLimit=d.miterLimit}const $=M.shapePrimitives;if(!O&&((tt=(rt=(X=S.hole)==null?void 0:X.shapePath)==null?void 0:rt.shapePrimitives)!=null&&tt.length)){const d=$[$.length-1];d.holes=S.hole.shapePath.shapePrimitives}for(let d=0;d<$.length;d++){const u=$[d];if(!(u!=null&&u.shape))continue;const f=u.transform,V=f&&!f.isIdentity(),w=k.texture&&k.texture!==Ut.WHITE,P=k.textureSpace==="global"?f:null,H=w?ie(Ae,k,u.shape,P):null,U=V?Fe.copyFrom(o).append(f):o,I=Le(k,dt,H,U);if(V&&(r.save(),r.transform(f.a,f.b,f.c,f.d,f.tx,f.ty)),O){const D=k;if(D.alignment!==.5&&!D.pixelLine){const c=[],j=[],Y=[],v=le[u.shape.type];if(v!=null&&v.build(u.shape,c)){const St=u.shape.closePath??!0;ce(c,D,!1,St,j,Y),r.fillStyle=I,He(r,j,Y)}else r.strokeStyle=I,r.beginPath(),ct(r,u.shape),r.stroke()}else r.strokeStyle=I,r.beginPath(),ct(r,u.shape),r.stroke()}else r.fillStyle=I,r.beginPath(),ct(r,u.shape),We(r,u.holes)?r.fill("evenodd"):r.fill();V&&r.restore()}}r.restore()}destroy(){this.shader=null}}zt.extension={type:[C.CanvasPipesAdaptor],name:"graphics"};class qe{init(t,e){this._renderer=t,this._renderTargetSystem=e}initGpuRenderTarget(t){const e=t.colorTexture,{canvas:s,context:n}=this._ensureCanvas(e);return{canvas:s,context:n,width:s.width,height:s.height}}resizeGpuRenderTarget(t){const e=t.colorTexture,{canvas:s}=this._ensureCanvas(e);s.width=t.pixelWidth,s.height=t.pixelHeight}startRenderPass(t,e,s,n){const r=this._renderTargetSystem.getGpuRenderTarget(t);this._renderer.canvasContext.activeContext=r.context,this._renderer.canvasContext.activeResolution=t.resolution,e&&this.clear(t,e,s,n)}clear(t,e,s,n){const o=this._renderTargetSystem.getGpuRenderTarget(t).context,i=n||{x:0,y:0,width:t.pixelWidth,height:t.pixelHeight};if(o.setTransform(1,0,0,1,0,0),o.clearRect(i.x,i.y,i.width,i.height),s){const l=Ht.shared.setValue(s);l.alpha>0&&(o.globalAlpha=l.alpha,o.fillStyle=l.toHex(),o.fillRect(i.x,i.y,i.width,i.height),o.globalAlpha=1)}}finishRenderPass(){}copyToTexture(t,e,s,n,r){const i=this._renderTargetSystem.getGpuRenderTarget(t).canvas,l=e.source,{context:m}=this._ensureCanvas(l),x=(r==null?void 0:r.x)??0,R=(r==null?void 0:r.y)??0;return m.drawImage(i,s.x,s.y,n.width,n.height,x,R,n.width,n.height),l.update(),e}destroyGpuRenderTarget(t){}_ensureCanvas(t){let e=t.resource;(!e||!ue.test(e))&&(e=Et.get().createCanvas(t.pixelWidth,t.pixelHeight),t.resource=e),(e.width!==t.pixelWidth||e.height!==t.pixelHeight)&&(e.width=t.pixelWidth,e.height=t.pixelHeight);const s=e.getContext("2d");return{canvas:e,context:s}}}class Xt extends xe{constructor(t){super(t),this.adaptor=new qe,this.adaptor.init(t,this)}}Xt.extension={type:[C.CanvasSystem],name:"renderTarget"};class $t{constructor(t){}init(){}initSource(t){}generateCanvas(t){const e=Et.get().createCanvas(),s=e.getContext("2d"),n=b.getCanvasSource(t);if(!n)return e;const r=t.frame,o=t.source._resolution??t.source.resolution??1,i=r.x*o,l=r.y*o,m=r.width*o,x=r.height*o;return e.width=Math.ceil(m),e.height=Math.ceil(x),s.drawImage(n,i,l,m,x,0,0,m,x),e}getPixels(t){const e=this.generateCanvas(t);return{pixels:e.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,e.width,e.height).data,width:e.width,height:e.height}}destroy(){}}$t.extension={type:[C.CanvasSystem],name:"texture"};const Oe=[...ge,jt,Yt,$t,Xt],Ve=[Ce,_e,ye,ve,be,Nt,Ot,Te],Ne=[we,zt],Jt=[],Kt=[],Qt=[];z.handleByNamedList(C.CanvasSystem,Jt);z.handleByNamedList(C.CanvasPipes,Kt);z.handleByNamedList(C.CanvasPipesAdaptor,Qt);z.add(...Oe,...Ve,...Ne);class Xe extends pe{constructor(){const t={name:"canvas",type:fe.CANVAS,systems:Jt,renderPipes:Kt,renderPipeAdaptors:Qt};super(t)}}export{Xe as CanvasRenderer};
